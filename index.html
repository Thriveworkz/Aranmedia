<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aran Media Payroll</title>
  <style>
    :root { --border:#e5e5e5; --muted:#666; }
    body{font-family:system-ui,Arial,sans-serif;max-width:900px;margin:2rem auto;padding:0 1rem;line-height:1.45}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:.5rem;flex-wrap:wrap}
    .card{border:1px solid var(--border);border-radius:12px;padding:1rem;margin:.75rem 0;background:#fff}
    button{padding:.6rem 1rem;border:1px solid #222;background:#222;color:#fff;border-radius:10px;cursor:pointer}
    input,select{padding:.5rem;border:1px solid var(--border);border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{border:1px solid var(--border);padding:.5rem;text-align:left;font-size:.95rem}
    th{background:#fafafa}
    .row{display:flex;gap:1rem;flex-wrap:wrap}
    .row > *{flex:1}
    .muted{color:var(--muted)}
    .right{display:flex;gap:.5rem;align-items:center}
  </style>
</head>
<body>
<header>
  <h2>Aran Media – Payroll</h2>
  <small class="muted">Monthly pay • Absence & loans deducted • Bonus ad-hoc • Sundays off</small>
</header>

<div class="card">
  <div class="row">
    <div>
      <label>Month (YYYY-MM)</label><br/>
      <input id="month" placeholder="2025-09" />
    </div>
    <div class="right" style="align-self:flex-end">
      <button id="previewBtn">Preview Payroll</button>
      <button id="exportBtn" title="Download CSV of payroll preview">Export CSV</button>
    </div>
  </div>
  <div id="payroll"></div>
</div>

<div class="card">
  <h3>Record Attendance</h3>
  <div class="row">
    <div><label>Date</label><br/><input id="attDate" type="date" /></div>
    <div><label>Emp Code</label><br/><input id="attCode" placeholder="E001" /></div>
    <div>
      <label>Status</label><br/>
      <select id="attStatus">
        <option value="P">P (Present)</option>
        <option value="A">A (Absent)</option>
      </select>
    </div>
  </div>
  <div class="row">
    <div><label>Notes</label><br/><input id="attNotes" placeholder="optional"/></div>
    <div style="align-self:flex-end"><button id="saveAttBtn">Save Attendance</button></div>
  </div>
  <div id="attMsg" class="muted"></div>
</div>

<div class="card">
  <div class="row">
    <div><button id="loadEmpBtn">Load Employees</button></div>
  </div>
  <div id="employees"></div>
</div>

<script>
// ---------- CONFIG ----------
const WEBAPP = 'https://script.google.com/macros/s/AKfycbwE8l-pbjrUq5DYCt0XlsXn_ehF4ro8VktmX1G4uytlTYLYTKWZbDQTSl4u-3CgxtNJ/exec';
const API_KEY = 'ARAN_MEDIA_PAYROLL_2025_SECRET_X9h2Lp7q';

// ---------- Helpers ----------
async function post(action, payload = {}) {
  const body = JSON.stringify({ apiKey: API_KEY, action, payload });
  const res = await fetch(WEBAPP, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' }, // avoid CORS preflight
    body
  });
  const text = await res.text();
  try { return JSON.parse(text); } catch (err) { throw new Error(text); }
}

function toCSV(rows) {
  if (!rows || !rows.length) return '';
  const headers = Object.keys(rows[0]);
  const esc = v => '"' + String(v ?? '').replace(/"/g,'""') + '"';
  const lines = rows.map(r => headers.map(h => esc(r[h])).join(','));
  return [headers.join(','), ...lines].join('\n');
}

function download(name, content, mime='text/csv') {
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = name;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// ---------- UI Actions ----------
document.getElementById('loadEmpBtn').onclick = async function () {
  const out = document.getElementById('employees');
  out.innerHTML = 'Loading...';
  try {
    const r = await post('listEmployees');
    if (!r.ok) throw new Error(r.error || 'Unknown error');
    out.innerHTML = '<table>' +
      '<thead><tr><th>EmpCode</th><th>Name</th><th>Monthly Salary</th><th>DOJ</th></tr></thead>' +
      '<tbody>' +
      r.employees.map(function(e){
        return '<tr><td>'+e.EmpCode+'</td><td>'+e.Name+'</td><td>'+e.MonthlySalary+'</td><td>'+(e.DOJ||'')+'</td></tr>';
      }).join('') +
      '</tbody></table>';
  } catch (e) {
    out.innerHTML = '<span style="color:red">'+e.message+'</span>';
  }
};

document.getElementById('saveAttBtn').onclick = async function () {
  const date = document.getElementById('attDate').value;
  const empCode = document.getElementById('attCode').value.trim();
  const status = document.getElementById('attStatus').value;
  const notes = document.getElementById('attNotes').value.trim();
  const msg = document.getElementById('attMsg');
  msg.textContent = 'Saving...';
  try {
    const r = await post('recordAttendance', { date: date, empCode: empCode, status: status, notes: notes });
    if (!r.ok) throw new Error(r.error || 'Unknown error');
    msg.textContent = 'Saved ✅';
  } catch (e) {
    msg.innerHTML = '<span style="color:red">'+e.message+'</span>';
  }
};

var lastPayroll = [];

document.getElementById('previewBtn').onclick = async function () {
  const month = document.getElementById('month').value.trim();
  const out = document.getElementById('payroll');
  out.innerHTML = 'Calculating...';
  try {
    const r = await post('runPayroll', { month: month });
    if (!r.ok) throw new Error(r.error || 'Unknown error');
    const rows = r.payroll || [];
    lastPayroll = rows;
    const total = rows.reduce(function(s, x){ return s + Number(x.netPay || 0); }, 0);
    if (!rows.length) {
      out.innerHTML = '<span class="muted">No employees or no data for this month.</span>';
      return;
    }
    out.innerHTML =
      '<table>' +
      '<thead><tr>' +
      '<th>Emp</th><th>Name</th><th>Working</th><th>Present</th><th>Absent</th>' +
      '<th>Per-Day</th><th>Gross</th><th>Attn Deduction</th><th>Loan</th><th>Bonus</th><th>Net</th>' +
      '</tr></thead>' +
      '<tbody>' +
      rows.map(function(x){
        return '<tr>' +
          '<td>'+x.EmpCode+'</td><td>'+x.Name+'</td><td>'+x.workingDays+'</td><td>'+x.presentDays+'</td><td>'+x.absentDays+'</td>' +
          '<td>'+x.perDay+'</td><td>'+x.gross+'</td><td>'+x.attendanceDeduction+'</td><td>'+x.loanRecovery+'</td><td>'+x.bonus+'</td><td><strong>'+x.netPay+'</strong></td>' +
        '</tr>';
      }).join('') +
      '</tbody>' +
      '<tfoot><tr><th colspan="10" style="text-align:right">Total Net</th><th>'+Math.round(total*100)/100+'</th></tr></tfoot>' +
      '</table>';
  } catch (e) {
    out.innerHTML = '<span style="color:red">'+e.message+'</span>';
  }
};

document.getElementById('exportBtn').onclick = function () {
  if (!lastPayroll.length) { alert('Run Preview Payroll first.'); return; }
  const month = document.getElementById('month').value.trim() || 'payroll';
  download('aran_payroll_'+month+'.csv', toCSV(lastPayroll));
};
</script>
</body>
</html>
